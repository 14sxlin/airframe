<html><head><title>Airframe: airframe-http</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Taro L. Saito" /><meta name="description" content="Lightweight Building Blocks for Scala" /><meta name="og:image" content="/airframe/img/poster.png" /><meta name="image" property="og:image" content="/airframe/img/poster.png" /><meta name="og:title" content="Airframe: airframe-http" /><meta name="title" property="og:title" content="Airframe: airframe-http" /><meta name="og:site_name" content="Airframe" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Lightweight Building Blocks for Scala" /><link rel="icon" type="image/png" href="/airframe/img/favicon.png" /><meta name="twitter:title" content="Airframe: airframe-http" /><meta name="twitter:image" content="https://wvlet.org/airframe/img/poster.png" /><meta name="twitter:description" content="Lightweight Building Blocks for Scala" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/airframe/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/airframe/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/airframe/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/airframe/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/airframe/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/airframe/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/airframe/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/airframe/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/airframe/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/airframe/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/airframe/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/airframe/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/airframe/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/airframe/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/airframe/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/airframe/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/airframe/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/airframe/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/airframe/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/airframe/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/airframe/highlight/styles/ocean.css" /><link rel="stylesheet" href="/airframe/css/style.css" /><link rel="stylesheet" href="/airframe/css/palette.css" /><link rel="stylesheet" href="/airframe/css/codemirror.css" /><link rel="stylesheet" href="/airframe/css/solarized-dark.css" /><link rel="stylesheet" href="/airframe/css/overwrite.css" /><script async="async">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-98364158-1' , 'auto');
ga('send', 'pageview');
      </script></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/airframe/" class="brand"><div class="brand-wrapper"><span>Airframe</span></div></a></li> <li><a href="/airframe/docs/index.html" class="">Airframe Overview</a></li> <li><a href="/airframe/docs/release-notes.html" class="">Release Notes</a></li> <li><a href="/airframe/docs/airframe.html" class="">Airframe DI</a> <ul class="sub_section"> <li><a href="/airframe/docs/airframe.html#bind" class="">Bind</a></li> <li><a href="/airframe/docs/airframe.html#design" class="">Design</a></li> <li><a href="/airframe/docs/airframe.html#session" class="">Session</a></li> <li><a href="/airframe/docs/airframe.html#life-cycle" class="">Life Cycle</a></li> <li><a href="/airframe/docs/use-cases.html" class="">Use Cases</a></li> <li><a href="/airframe/docs/bindings.html" class="">Advanced Binding Types</a></li> <li><a href="/airframe/docs/debug.html" class="">Debugging DI</a></li> <li><a href="/airframe/docs/comparison.html" class="">DI Framework Comparison</a></li> <li><a href="/airframe/docs/internals.html" class="">Airframe Internals</a></li></ul></li> <li><a href="/airframe/docs/airspec.html" class="">AirSpec Testing Framework</a></li> <li><a href="/airframe/docs/index.html" class="">Airframe Modules</a> <ul class="sub_section"> <li><a href="/airframe/docs/airframe-canvas.html" class="">airframe-canvas</a></li> <li><a href="/airframe/docs/airframe-codec.html" class="">airframe-codec</a></li> <li><a href="/airframe/docs/airframe-config.html" class="">airframe-config</a></li> <li><a href="/airframe/docs/airframe-control.html" class="">airframe-control</a></li> <li><a href="/airframe/docs/airframe-fluentd.html" class="">airframe-fluentd</a></li> <li><a href="/airframe/docs/airframe-http.html" class=" active ">airframe-http</a></li> <li><a href="/airframe/docs/airframe-http-recorder.html" class="">airframe-http-recorder</a></li> <li><a href="/airframe/docs/airframe-jdbc.html" class="">airframe-jdbc</a></li> <li><a href="/airframe/docs/airframe-jmx.html" class="">airframe-jmx</a></li> <li><a href="/airframe/docs/airframe-json.html" class="">airframe-json</a></li> <li><a href="/airframe/docs/airframe-launcher.html" class="">airframe-launcher</a></li> <li><a href="/airframe/docs/airframe-log.html" class="">airframe-log</a></li> <li><a href="/airframe/docs/airframe-metrics.html" class="">airframe-metrics</a></li> <li><a href="/airframe/docs/airframe-msgpack.html" class="">airframe-msgpack</a></li> <li><a href="/airframe/docs/airframe-scalatest.html" class="">airframe-scalatest</a></li> <li><a href="/airframe/docs/airframe-surface.html" class="">airframe-surface</a></li> <li><a href="/airframe/docs/airframe-sql.html" class="">airframe-sql</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/wvlet/airframe"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/wvlet/airframe"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Airframe Lightweight Building Blocks for Scala');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Airframe Lightweight Building Blocks for Scala');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="wvlet" data-github-repo="airframe"><div class="content-wrapper"><section><h1 id="airframe-http">airframe-http</h1>

<p>airframe-http is a library for creating HTTP web servers at ease.
<strong>airframe-http-finagle</strong> is an extention of airframe-http to use Finagle as a backend HTTP server.</p>

<ul>
  <li>Blog article: <a href="https://medium.com/@taroleo/airframe-http-a-minimalist-approach-for-building-web-services-in-scala-743ba41af7f">Airframe HTTP: Building Low-Friction Web Services Over Finagle</a></li>
</ul>

<h1 id="airframe-http-finagle">airframe-http-finagle</h1>

<p><strong>build.sbt</strong></p>

<p><a href="http://central.maven.org/maven2/org/wvlet/airframe/airframe-http-finagle_2.12/"><img src="https://maven-badges.herokuapp.com/maven-central/org.wvlet.airframe/airframe-http-finagle_2.12/badge.svg" alt="Maven Central" /></a>
<a href="http://javadoc-badge.appspot.com/org.wvlet.airframe/airframe-http_2.12"><img src="http://javadoc-badge.appspot.com/org.wvlet.airframe/airframe-http_2.12.svg?label=scaladoc" alt="Scaladoc" /></a></p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"org.wvlet.airframe"</span> <span class="o">%%</span> <span class="s">"airframe-http-finagle"</span> <span class="o">%</span> <span class="o">(</span><span class="n">version</span><span class="o">)</span>
</code></pre></div></div>

<h2 id="defining-http-endpoints">Defining HTTP Endpoints</h2>

<p><strong>MyApi.scala</strong></p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.twitter.finagle.http.</span><span class="o">{</span><span class="nc">Request</span><span class="o">,</span><span class="nc">Response</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.twitter.util.Future</span>
<span class="k">import</span> <span class="nn">wvlet.airframe.http.</span><span class="o">{</span><span class="nc">Endpoint</span><span class="o">,</span> <span class="nc">HttpMethod</span><span class="o">,</span> <span class="nc">HttpRequest</span><span class="o">}</span>


<span class="k">object</span> <span class="nc">MyApi</span> <span class="o">{</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">NewUserRequest</span><span class="o">(</span><span class="n">name</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">ServerInfo</span><span class="o">(</span><span class="n">version</span><span class="k">:</span><span class="kt">String</span><span class="o">,</span> <span class="n">ua</span><span class="k">:</span><span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>
<span class="o">}</span>

<span class="c1">// [Optional] Specify a common prefix for all endpoints
</span><span class="nd">@Endpoint</span><span class="o">(</span><span class="n">path</span><span class="o">=</span><span class="s">"/v1"</span><span class="o">)</span>
<span class="k">trait</span> <span class="nc">MyApi</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">MyApi._</span>

  <span class="c1">// Binding http path parameters (e.g., :name) to method arguments
</span>  <span class="nd">@Endpoint</span><span class="o">(</span><span class="n">method</span> <span class="k">=</span> <span class="nv">HttpMethod</span><span class="o">.</span><span class="py">GET</span><span class="o">,</span> <span class="n">path</span> <span class="k">=</span> <span class="s">"/user/:name"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=</span> <span class="nc">User</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>

  <span class="c1">// Receive a JSON request body {"user":"leo"} to generate NewUserRequest instance
</span>  <span class="nd">@Endpoint</span><span class="o">(</span><span class="n">method</span> <span class="k">=</span> <span class="nv">HttpMethod</span><span class="o">.</span><span class="py">POST</span><span class="o">,</span> <span class="n">path</span> <span class="k">=</span> <span class="s">"/user"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">createNewUser</span><span class="o">(</span><span class="n">request</span><span class="k">:</span><span class="kt">NewUserRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=</span> <span class="nc">User</span><span class="o">(</span><span class="nv">request</span><span class="o">.</span><span class="py">name</span><span class="o">)</span>

  <span class="c1">// To read http request headers, add a method argument of HttpRequest[Request] type
</span>  <span class="nd">@Endpoint</span><span class="o">(</span><span class="n">method</span> <span class="k">=</span> <span class="nv">HttpMethod</span><span class="o">.</span><span class="py">GET</span><span class="o">,</span> <span class="n">path</span> <span class="k">=</span> <span class="s">"/info"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">getInfo</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HttpRequest</span><span class="o">[</span><span class="kt">Request</span><span class="o">])</span><span class="k">:</span> <span class="kt">ServerInfo</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">ServerInfo</span><span class="o">(</span><span class="s">"1.0"</span><span class="o">,</span> <span class="nv">request</span><span class="o">.</span><span class="py">toRaw</span><span class="o">.</span><span class="py">userAgent</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">// It is also possible to receive backend server specific Request type
</span>  <span class="nd">@Endpoint</span><span class="o">(</span><span class="n">method</span> <span class="k">=</span> <span class="nv">HttpMethod</span><span class="o">.</span><span class="py">GET</span><span class="o">,</span> <span class="n">path</span> <span class="k">=</span> <span class="s">"/info2"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">getInfo</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Request</span><span class="o">)</span><span class="k">:</span> <span class="kt">ServerInfo</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">ServerInfo</span><span class="o">(</span><span class="s">"1.0"</span><span class="o">,</span> <span class="nv">request</span><span class="o">.</span><span class="py">userAgent</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">// Returning Future[X] is also possible.
</span>  <span class="c1">// This style is convenient when you need to call another service that returns Future response.
</span>  <span class="nd">@Endpoint</span><span class="o">(</span><span class="n">method</span> <span class="k">=</span> <span class="nv">HttpMethod</span><span class="o">.</span><span class="py">GET</span><span class="o">,</span> <span class="n">path</span> <span class="k">=</span> <span class="s">"/info_f"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">getInfoFuture</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HttpRequest</span><span class="o">[</span><span class="kt">Request</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">ServerInfo</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nv">Future</span><span class="o">.</span><span class="py">value</span><span class="o">(</span><span class="nc">ServerInfo</span><span class="o">(</span><span class="s">"1.0"</span><span class="o">,</span> <span class="nv">request</span><span class="o">.</span><span class="py">toRaw</span><span class="o">.</span><span class="py">userAgent</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="c1">// It is also possible to return custom HTTP responses
</span>  <span class="nd">@EndPoint</span><span class="o">(</span><span class="n">method</span> <span class="k">=</span> <span class="nv">HttpMethod</span><span class="o">.</span><span class="py">GET</span><span class="o">,</span> <span class="n">path</span> <span class="k">=</span> <span class="s">"/custom_response"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">customResponse</span><span class="k">:</span> <span class="kt">Response</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">response</span> <span class="k">=</span> <span class="nc">Reponse</span><span class="o">()</span>
    <span class="nv">response</span><span class="o">.</span><span class="py">contentString</span> <span class="k">=</span> <span class="s">"hello airframe-http"</span>
    <span class="n">response</span>
  <span class="o">}</span>

  <span class="k">import</span> <span class="nn">com.twitter.io.</span><span class="o">{</span><span class="nc">Buf</span><span class="o">,</span><span class="nc">Reader</span><span class="o">}</span>
  <span class="c1">// If you return a Reader, the response will be streamed (i.e., it uses less memory)
</span>  <span class="nd">@EndPoint</span><span class="o">(</span><span class="n">method</span> <span class="k">=</span> <span class="nv">HttpMethod</span><span class="o">.</span><span class="py">GET</span><span class="o">,</span> <span class="n">path</span> <span class="k">=</span> <span class="s">"/stream_response"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">streamingResponse</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
     <span class="nv">Reader</span><span class="o">.</span><span class="py">fromSeq</span><span class="o">(</span><span class="nc">Seq</span><span class="o">(</span><span class="nc">User</span><span class="o">(</span><span class="s">"leo"</span><span class="o">),</span> <span class="nc">User</span><span class="o">(</span><span class="s">"yui"</span><span class="o">)))</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This <code class="highlighter-rouge">MyApi</code> defines these http end points:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET  /v1/user/:name    returns {"name":"..."}
POST /v1/user          returns {"name":"..."}
GET  /v1/info          returns {"version":"1.0", "ua":"...."}
GET  /v1/info2         returns {"version":"1.0", "ua":"...."}
GET  /v1/info_f        returns {"version":"1.0", "ua":"...."}
...
</code></pre></div></div>

<p>Mapping between JSON values and Scala objects will be handled automatically.</p>

<h3 id="path-parameter-types">Path Parameter Types</h3>

<table>
  <thead>
    <tr>
      <th>pattern</th>
      <th>description</th>
      <th>example</th>
      <th>input example</th>
      <th>binding</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>:arg</td>
      <td>single match</td>
      <td>/v1/user/:id</td>
      <td>/v1/user/1</td>
      <td>id = 1</td>
    </tr>
    <tr>
      <td>*arg</td>
      <td>tail match</td>
      <td>/v1/entry/*key</td>
      <td>/v1/entry/config/version</td>
      <td>key = config/version</td>
    </tr>
  </tbody>
</table>

<p><code class="highlighter-rouge">*arg</code> can be used only at the end of the path.</p>

<h3 id="messagepack-support">MessagePack Support</h3>

<p>If an HTTP POST request has <code class="highlighter-rouge">Content-Type: application/x-msgpack</code> header, airframe-http
will read the content body of the request as <a href="https://msgpack.org">MessagePack</a> data, and bind it to the method arguments using
<a href="https://wvlet.org/airframe/docs/airframe-codec.html">airframe-codec</a>,
which will manage data type conversions (e.g, from msgpack into Int or objects) automatically.</p>

<p>If an HTTP request has <code class="highlighter-rouge">Accept: application/x-msgpack</code> header, the response body will be
encoded with MessagePack format. This is useful for reducing the response size and
sending data to the client as is. For example, JSON cannot represent precise double values and binary data
without some transformations. With MessagePack, you can send the data to the client more naturally.</p>

<h2 id="starting-a-finagle-http-server">Starting A Finagle HTTP Server</h2>

<p>To start a server, create a finagle server configuration with Finagle.server, and</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>
<span class="k">import</span> <span class="nn">wvlet.airframe.http.finagle._</span>
<span class="k">import</span> <span class="nn">com.twitter.finagle.http.Request</span>

<span class="c1">// Define API routes. This will read all @Endpoint annotations in MyApi
// You can add more routes by using `.add[X]` method.
</span><span class="k">val</span> <span class="nv">router</span> <span class="k">=</span> <span class="nv">Router</span><span class="o">.</span><span class="py">add</span><span class="o">[</span><span class="kt">MyApi</span><span class="o">]</span>

<span class="nv">Finagle</span><span class="o">.</span><span class="py">server</span>
  <span class="o">.</span><span class="py">withPort</span><span class="o">(</span><span class="mi">8080</span><span class="o">)</span>
  <span class="o">.</span><span class="py">withRouter</span><span class="o">(</span><span class="n">router</span><span class="o">)</span>
  <span class="o">.</span><span class="py">start</span> <span class="o">{</span> <span class="n">server</span> <span class="k">=&gt;</span>
    <span class="c1">// Finagle http server will start here
</span>    <span class="c1">// To keep running the server, run `server.waitServerTermination`:
</span>    <span class="nv">server</span><span class="o">.</span><span class="py">waitServerTermination</span>
  <span class="o">}</span>
<span class="c1">// The server will terminate here
</span></code></pre></div></div>

<h2 id="customizing-finagle">Customizing Finagle</h2>

<p>To customize Finagle, use <code class="highlighter-rouge">Finagle.server.withXXX</code> methods.</p>

<p>For example, you can:</p>
<ul>
  <li>Customize HTTP filters</li>
  <li>Start multiple Finagle HTTP servers with different configurations</li>
  <li>Add custom Tracer, StatsReceiver, etc.</li>
  <li>Add more advanced server configurations using <code class="highlighter-rouge">.withServerInitializer(...)</code></li>
</ul>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe.http.finagle._</span>

<span class="k">val</span> <span class="nv">router</span> <span class="k">=</span> <span class="nv">Router</span><span class="o">.</span><span class="py">add</span><span class="o">[</span><span class="kt">MyApi</span><span class="o">]</span>

<span class="k">val</span> <span class="nv">server</span> <span class="k">=</span> <span class="nv">Finagle</span><span class="o">.</span><span class="py">server</span>
  <span class="o">.</span><span class="py">withName</span><span class="o">(</span><span class="s">"my server"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">withRouter</span><span class="o">(</span><span class="n">router</span><span class="o">)</span>
  <span class="o">.</span><span class="py">withPort</span><span class="o">(</span><span class="mi">8080</span><span class="o">)</span>
  <span class="c1">// Enable tracer for Finagle
</span>  <span class="o">.</span><span class="py">withTracer</span><span class="o">(</span><span class="nc">ConsoleTracer</span><span class="o">)</span>
  <span class="c1">// Add your own Finagle specific customization here
</span>  <span class="o">.</span><span class="py">withServerInitializer</span><span class="o">{</span> <span class="n">x</span><span class="k">:</span> <span class="kt">Server</span> <span class="o">=&gt;</span> <span class="n">x</span> <span class="o">}</span>
  <span class="o">.</span><span class="py">withStatsReceiver</span><span class="o">(...)</span>
  <span class="c1">// Add a custom MessageCodec mapping
</span>  <span class="o">.</span><span class="py">withCustomCodec</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span><span class="nv">Surface</span><span class="o">.</span><span class="py">of</span><span class="o">[</span><span class="kt">X</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="o">...))</span>

<span class="nv">server</span><span class="o">.</span><span class="py">start</span> <span class="o">{</span> <span class="n">server</span> <span class="k">=&gt;</span>
  <span class="c1">// The customized server will start here
</span>  <span class="nv">server</span><span class="o">.</span><span class="py">waitServerTermination</span>  
<span class="o">}</span>
</code></pre></div></div>

<p>See also the examples in <a href="https://github.com/wvlet/airframe/blob/master/airframe-http-finagle/src/test/scala/wvlet/airframe/http/finagle/FinagleServerFactoryTest.scala">here</a></p>

<h2 id="integration-with-airframe-di">Integration with Airframe DI</h2>

<p>By calling <code class="highlighter-rouge">.design</code>, you can get a design for Airframe DI:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">design</span> <span class="k">=</span> <span class="nv">Finagle</span><span class="o">.</span><span class="py">server</span>
 <span class="o">.</span><span class="py">withName</span><span class="o">(</span><span class="s">"my-server"</span><span class="o">)</span>
 <span class="o">.</span><span class="py">withRouter</span><span class="o">(</span><span class="n">router</span><span class="o">)</span>
 <span class="o">.</span><span class="py">withPort</span><span class="o">(</span><span class="mi">8080</span><span class="o">)</span>
 <span class="o">.</span><span class="py">design</span>

<span class="nv">design</span><span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">FinagleServer</span><span class="o">]</span> <span class="o">{</span> <span class="n">server</span> <span class="k">=&gt;</span>
   <span class="c1">// A server will start here
</span><span class="o">}</span>
<span class="c1">// The server will terminate after exiting the session
</span></code></pre></div></div>

<h3 id="running-multiple-finagle-servers">Running Multiple Finagle Servers</h3>

<p>To run multiple HTTP servers, create a FinagleServerFactory and use <code class="highlighter-rouge">newFinagleServer(FinagleServerConfig)</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe.http.finagle._</span>

<span class="c1">// Use a design for not starting the default server:
</span><span class="nv">finagleBaseDesign</span><span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">FinagleServerFactory</span><span class="o">]</span> <span class="o">{</span> <span class="n">factory</span> <span class="k">=&gt;</span>
  <span class="k">val</span> <span class="nv">config1</span> <span class="k">=</span> <span class="nv">Finagle</span><span class="o">.</span><span class="py">server</span><span class="o">.</span><span class="py">withName</span><span class="o">(</span><span class="s">"server1"</span><span class="o">).</span><span class="py">withPort</span><span class="o">(</span><span class="mi">8080</span><span class="o">).</span><span class="py">withRouter</span><span class="o">(</span><span class="n">router1</span><span class="o">)</span>
  <span class="k">val</span> <span class="nv">config2</span> <span class="k">=</span> <span class="nv">Finagle</span><span class="o">.</span><span class="py">server</span><span class="o">.</span><span class="py">withName</span><span class="o">(</span><span class="s">"server2"</span><span class="o">).</span><span class="py">withPort</span><span class="o">(</span><span class="mi">8081</span><span class="o">).</span><span class="py">withRouter</span><span class="o">(</span><span class="n">router2</span><span class="o">)</span>

 <span class="nv">factory</span><span class="o">.</span><span class="py">newFinagleServer</span><span class="o">(</span><span class="n">config1</span><span class="o">)</span>
 <span class="nv">factory</span><span class="o">.</span><span class="py">newFinagleServer</span><span class="o">(</span><span class="n">config2</span><span class="o">)</span>
 <span class="c1">// Two finagle servers will start at port 8081 and 8081
</span><span class="o">}</span>
<span class="c1">// Two servers will be stopped after exiting the session
</span></code></pre></div></div>

<h2 id="shutting-down-finagle-server">Shutting Down Finagle Server</h2>

<p>Closing the current Airframe session will terminate the finagle server as well:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>
<span class="k">import</span> <span class="nn">wvlet.airframe.http._</span>

<span class="k">trait</span> <span class="nc">YourApi</span> <span class="o">{</span>
   <span class="c1">// Bind the current session
</span>   <span class="k">private</span> <span class="k">val</span> <span class="nv">session</span> <span class="k">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">Session</span><span class="o">]</span>

   <span class="nd">@Endpoint</span><span class="o">(</span><span class="n">path</span><span class="o">=</span><span class="s">"/v1/shutdown"</span><span class="o">,</span> <span class="n">method</span><span class="k">=</span><span class="nv">HttpMethod</span><span class="o">.</span><span class="py">POST</span><span class="o">)</span>
   <span class="k">def</span> <span class="nf">shutdown</span> <span class="o">{</span>
     <span class="c1">// Closing the current session will terminate the FinagleServer too.
</span>     <span class="nv">session</span><span class="o">.</span><span class="py">shutdown</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="static-content">Static Content</h2>

<p>To return static contents (e.g., html, image files, etc.), use <code class="highlighter-rouge">StaticContent.fromResource(resourceBasePath, relativePath)</code>. This method finds a file from your class paths (e.g., files in dependency jar files or resource files).</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">StaticContentServer</span> <span class="o">{</span>
  <span class="nd">@Endpoint</span><span class="o">(</span><span class="n">path</span><span class="o">=</span><span class="s">"/content/*path"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">content</span><span class="o">(</span><span class="n">path</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nv">StaticContent</span><span class="o">.</span><span class="py">fromResource</span><span class="o">(</span><span class="n">basePath</span> <span class="k">=</span> <span class="s">"/your/resource/package/path"</span><span class="o">,</span> <span class="n">path</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="error-handling">Error Handling</h2>

<p>To handle errors that happens during the request processing, return HttpServerException with a custom HttpStatus code.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// This will return 403 http response to the client
</span><span class="k">throw</span> <span class="nc">HttpServerException</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="nv">HttpStatus</span><span class="o">.</span><span class="py">Forbidden_403</span><span class="o">,</span> <span class="s">"Forbidden"</span><span class="o">)</span>
</code></pre></div></div>

<p>If the endpoint returns Future type, returning just <code class="highlighter-rouge">Future[Throwable]</code> (will produce 500 response code) or <code class="highlighter-rouge">Future[HttpServerException]</code> to customize the response code by yourself will also work.</p>

<h2 id="filters">Filters</h2>

<p>Router supports nesting HTTP request filters (e.g., authentication, logging) before processing the final <code class="highlighter-rouge">@EndPoint</code> method:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>
<span class="k">import</span> <span class="nn">wvlet.airframe.http._</span>
<span class="k">import</span> <span class="nn">wvlet.airframe.http.finagle._</span>

<span class="c1">// Your endpoint definition
</span><span class="k">class</span> <span class="nc">MyApp</span> <span class="o">{</span>
  <span class="nd">@Endpoint</span><span class="o">(</span><span class="n">method</span> <span class="k">=</span> <span class="nv">HttpMethod</span><span class="o">.</span><span class="py">GET</span><span class="o">,</span> <span class="n">path</span> <span class="k">=</span> <span class="s">"/user/:name"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=</span> <span class="nc">User</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
<span class="o">}</span>

<span class="c1">// Implement FinagleFilter (or HttpFilter[Req, Resp, F])
// to define a custom filter that will be applied before the endpoint processing.
</span><span class="k">object</span> <span class="nc">LoggingFilter</span> <span class="k">extends</span> <span class="nc">FinagleFilter</span> <span class="k">with</span> <span class="nc">LogSupport</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">apply</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Request</span><span class="o">,</span> <span class="n">context</span><span class="k">:</span> <span class="kt">Context</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Response</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nf">info</span><span class="o">(</span><span class="n">s</span><span class="s">"${request.path} is accessed"</span><span class="o">)</span>
    <span class="c1">// Call the child
</span>    <span class="nf">context</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Use .andThen[X] for nesting filters
</span><span class="nc">Router</span>
 <span class="o">.</span><span class="py">add</span><span class="o">(</span><span class="nc">LoggingFilter</span><span class="o">)</span>
 <span class="o">.</span><span class="py">andThen</span><span class="o">[</span><span class="kt">MyApp</span><span class="o">]</span>
</code></pre></div></div>

<h3 id="thread-local-storage">Thread-Local Storage</h3>

<p>To pass data between filters and applications, you can use thread-local storage in the context:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">LoggingFilter</span> <span class="k">extends</span> <span class="nc">FinagleFilter</span> <span class="k">with</span> <span class="nc">LogSupport</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">apply</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Request</span><span class="o">,</span> <span class="n">context</span><span class="k">:</span> <span class="kt">FinagleContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Response</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nf">context</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="py">map</span> <span class="o">{</span> <span class="n">response</span> <span class="k">=&gt;</span>
      <span class="c1">// Read the thread-local parameter set in the context(request)
</span>      <span class="nv">context</span><span class="o">.</span><span class="py">getThreadLocal</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"user_id"</span><span class="o">).</span><span class="py">map</span> <span class="o">{</span> <span class="n">uid</span> <span class="k">=&gt;</span>
        <span class="nf">info</span><span class="o">(</span><span class="n">s</span><span class="s">"user_id: ${uid}"</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="n">response</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">AuthFilter</span> <span class="k">extends</span> <span class="nc">FinagleFilter</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">apply</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Request</span><span class="o">,</span> <span class="n">context</span><span class="k">:</span> <span class="kt">FinagleContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Response</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nf">if</span><span class="o">(</span><span class="nf">authorize</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span>
      <span class="nv">request</span><span class="o">.</span><span class="py">getParam</span><span class="o">(</span><span class="s">"user_id"</span><span class="o">).</span><span class="py">map</span> <span class="o">{</span> <span class="n">uid</span> <span class="k">=&gt;</span>
        <span class="c1">// Pass a thread-local parameter to the parent response handler
</span>        <span class="nv">context</span><span class="o">.</span><span class="py">setThreadLocal</span><span class="o">(</span><span class="s">"user_id"</span><span class="o">,</span> <span class="n">uid</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="nf">context</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>


<span class="nc">Router</span>
  <span class="o">.</span><span class="py">add</span><span class="o">[</span><span class="kt">LoggingFilter</span><span class="o">]</span>
  <span class="o">.</span><span class="py">andThen</span><span class="o">[</span><span class="kt">AuthFilter</span><span class="o">]</span>
  <span class="o">.</span><span class="py">andThen</span><span class="o">[</span><span class="kt">MyApp</span><span class="o">]</span>
</code></pre></div></div>

<p>Using local variables inside filters will not work because the request processing will happen when Future[X] is evaluated, so we must use thead-local parmeter holder, which will be prepared for each request call.</p>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/airframe/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script>((window.gitter = {}).chat = {}).options = {
room: 'wvlet/airframe'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/airframe/js/main.js"></script></body></html>